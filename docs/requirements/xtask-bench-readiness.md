# xtask bench 服务就绪策略

更新时间：2025-08-27

## 背景

`xtask bench` 目前在启动基准服务后仅等待固定的 500ms 就直接启动压测工具。
在实际运行中，编译、链接和 runtime 初始化经常超过这个时间，导致压测阶段大量
请求在服务器尚未监听端口时发送，引发 `connection refused` 并污染压测数据。

## 目标

在启动压测前确保基准服务已经完成监听，避免产生大量拒绝连接错误，保证压测数据
可靠。其中包括：
- 在压测启动前探测目标地址，确认能够建立 TCP 连接；
- 可选地执行一次 HTTP 预检，确保处理器已经正常工作；
- 为探活设置合理超时，超时后应中止压测并提示用户。

## 功能范围

- 仅改动 `xtask bench` 流程，其他 xtask 子命令不受影响；
- 不改动 benchmark 服务代码；
- 不强制引入额外依赖，如必须则保持最小化。

## 非目标

- 不对压测工具（如 bombardier）进行功能扩展；
- 不在此改动中引入外部心跳服务或额外进程管理逻辑。

## 验收标准

- 压测启动前对目标地址进行探活；
- 如在设定超时内未探活成功，压测应中止并返回错误；
- 探活成功时压测不再出现大规模 `connection refused`；
- `cargo check` 通过。
