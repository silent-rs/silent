# 路由 append 合并策略

更新时间：2025-08-27

## 背景

当前路由树在通过 `append` 注册路由时，如果遇到相同的 `path`，会分别生成多个路由节点。随着配置增多，产生重复节点导致：
- 中间件链条分散，执行顺序不确定；
- 同路径但不同处理器无法共享子节点和后续匹配；
- 路由树结构冗余，增加查找和维护成本。

## 目标

当追加路由时，遇到相同 `path` 需要合并为单个路由节点。合并过程中必须：
- 合并中间件数组并保持已有顺序；
- 合并子路由树，确保新旧子节点都可访问；
- 对处理器（handler）按照原 append 序仍可注册，保持兼容；
- 不破坏既有对外行为。

## 功能范围

- 仅影响路由追加阶段的数据结构处理；
- 不修改路由匹配与执行逻辑；
- 保证原有 API/trait 接口不发生破坏性变更。

## 非目标

- 不调整中间件执行模型（已有洋葱模型重构文档覆盖）；
- 不修改路径解析或匹配算法。

## 验收标准

- 相同路径的路由通过 `append` 后只存在一个节点；
- 中间件和子节点在合并后完整保留，并按照注册顺序执行；
- `cargo check`/`cargo clippy` 可通过；
- 现有示例和测试不受破坏。
